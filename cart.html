<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | Virtual Mega Mall</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="prism.css"> <!-- Prism Interface Design System -->
    <link rel="stylesheet" href="cookie-consent.css"> <!-- Cookie Consent Modal -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            color: #fff;
            min-height: 100vh;
        }

        .cart-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
        }

        .cart-section h2 {
            margin-bottom: 25px;
            font-size: 24px;
        }

        /* Cart Items */
        .cart-item {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .cart-item img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }

        .item-details {
            flex: 1;
        }

        .item-details h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .item-details .brand {
            color: #888;
            font-size: 13px;
        }

        .item-details .price {
            color: var(--hazel-gold);
            font-weight: 600;
            font-size: 18px;
            margin-top: 8px;
        }

        .item-delivery {
            font-size: 12px;
            color: #4CAF50;
            margin-top: 5px;
        }

        .item-delivery i {
            margin-right: 5px;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #444;
            background: transparent;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
        }

        .qty-btn:hover {
            background: var(--hazel-gold);
            color: #111;
            border-color: var(--hazel-gold);
        }

        .item-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            color: var(--hazel-gold);
        }

        .action-btn.remove:hover {
            color: #ff4757;
        }

        /* Promo Code */
        .promo-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .promo-section h4 {
            margin-bottom: 15px;
            font-size: 14px;
        }

        .promo-input {
            display: flex;
            gap: 10px;
        }

        .promo-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #444;
            background: transparent;
            color: #fff;
            border-radius: 10px;
            font-size: 14px;
        }

        .promo-input input:focus {
            outline: none;
            border-color: var(--hazel-gold);
        }

        .promo-input button {
            padding: 12px 25px;
            background: var(--hazel-gold);
            color: #111;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .promo-applied {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4CAF50;
            margin-top: 10px;
            font-size: 13px;
        }

        /* Order Summary */
        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            position: sticky;
            top: 100px;
        }

        .summary-card h3 {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
            color: #aaa;
        }

        .summary-row.discount {
            color: #4CAF50;
        }

        .summary-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.2);
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: var(--hazel-gold);
            color: #111;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.3s;
        }

        .checkout-btn:hover {
            background: #d4b076;
        }

        .secure-note {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            font-size: 12px;
            color: #888;
        }

        .secure-note i {
            color: #4CAF50;
        }

        /* Saved Items */
        .saved-section {
            margin-top: 40px;
        }

        .saved-section h3 {
            margin-bottom: 20px;
        }

        .saved-item {
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .saved-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        .saved-item .move-btn {
            padding: 8px 15px;
            background: transparent;
            border: 1px solid var(--hazel-gold);
            color: var(--hazel-gold);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .saved-item .move-btn:hover {
            background: var(--hazel-gold);
            color: #111;
        }

        /* Recommendations */
        .recommendations {
            margin-top: 40px;
        }

        .recommendations h3 {
            margin-bottom: 20px;
        }

        .rec-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .rec-card {
            min-width: 180px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: 0.3s;
        }

        .rec-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .rec-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 8px;
        }

        .rec-card h4 {
            font-size: 13px;
            margin: 10px 0 5px;
        }

        .rec-card .price {
            color: var(--hazel-gold);
            font-size: 14px;
            font-weight: 600;
        }

        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-cart i {
            font-size: 60px;
            color: #444;
            margin-bottom: 20px;
        }

        .empty-cart h3 {
            margin-bottom: 15px;
        }

        .empty-cart p {
            color: #888;
            margin-bottom: 25px;
        }

        .shop-btn {
            display: inline-block;
            padding: 14px 40px;
            background: var(--hazel-gold);
            color: #111;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
        }

        @media (max-width: 900px) {
            .cart-page {
                grid-template-columns: 1fr;
            }

            .summary-card {
                position: relative;
                top: 0;
            }
        }
    </style>
    <script src="cookie-consent.js" defer></script> <!-- Cookie Consent Script -->
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="logo" style="text-decoration:none;">VIRTUAL MEGA MALL</a>
        <div class="nav-icons">
            <a href="index.html" class="nav-icon"><i class="fa-solid fa-home"></i></a>
            <a href="cart.html" class="nav-icon cart-icon"><i class="fa-solid fa-bag-shopping"></i><span
                    class="cart-badge" id="cart-badge">0</span></a>
        </div>
    </nav>

    <div class="cart-page">
        <!-- Left: Cart Items -->
        <div class="cart-section">
            <h2><i class="fa-solid fa-bag-shopping"></i> Your Shopping Bag</h2>
            <div id="cart-items"></div>

            <!-- Promo Code -->
            <div class="promo-section">
                <h4><i class="fa-solid fa-tag"></i> Have a promo code?</h4>
                <div class="promo-input">
                    <input type="text" id="promo-code" placeholder="Enter code">
                    <button onclick="applyPromo()">Apply</button>
                </div>
                <div class="promo-applied" id="promo-applied" style="display:none;">
                    <i class="fa-solid fa-check-circle"></i><span id="promo-msg"></span>
                </div>
            </div>

            <!-- Saved for Later -->
            <div class="saved-section" id="saved-section" style="display:none;">
                <h3><i class="fa-regular fa-bookmark"></i> Saved for Later</h3>
                <div id="saved-items"></div>
            </div>

            <!-- Recommendations -->
            <div class="recommendations">
                <h3>You May Also Like</h3>
                <div class="rec-scroll" id="recommendations"></div>
            </div>
        </div>

        <!-- Right: Summary -->
        <div>
            <div class="summary-card">
                <h3>Order Summary</h3>
                <div class="summary-row"><span>Subtotal</span><span id="subtotal">Rs. 0</span></div>
                <div class="summary-row"><span>Shipping</span><span id="shipping">Rs. 200</span></div>
                <div class="summary-row discount" id="discount-row" style="display:none;"><span>Discount</span><span
                        id="discount">-Rs. 0</span></div>
                <div class="summary-row total"><span>Total</span><span id="total">Rs. 0</span></div>
                <button class="checkout-btn" onclick="proceedToStripeCheckout()" id="checkout-btn">
                    <i class="fa-solid fa-lock"></i> Proceed to Checkout
                </button>
                <div class="secure-note"><i class="fa-solid fa-shield-halved"></i>Secure checkout powered by Stripe
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="cart-firestore.js"></script>
    <script src="script.js"></script>
    <script>
        let promoDiscount = 0;
        const promoCodes = { 'SAVE10': 10, 'MEGA20': 20, 'FIRST15': 15 };
        let cartUnsubscribe = null;
        let currentCartItems = [];

        // Check auth and load cart
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = 'login.html?return=cart.html';
                return;
            }

            // User logged in, load cart with real-time sync
            cartUnsubscribe = getCartItemsLive(items => {
                currentCartItems = items;
                renderCart(items);
            });
        });

        function renderCart(cartItems) {
            const container = document.getElementById('cart-items');

            if (cartItems.length === 0) {
                container.innerHTML = `<div class="empty-cart"><i class="fa-solid fa-bag-shopping"></i><h3>Your cart is empty</h3><p>Looks like you haven't added anything yet</p><a href="index.html" class="shop-btn">Start Shopping</a></div>`;
                updateSummary(0);
                return;
            }

            let subtotal = 0;
            container.innerHTML = cartItems.map((item) => {
                const price = parseInt(item.price.replace(/[^0-9]/g, ''));
                subtotal += price * item.quantity;
                return `
                <div class="cart-item">
                    <img src="${item.imageUrl}" alt="${item.name}">
                    <div class="item-details">
                        <h4>${item.name}</h4>
                        <div class="brand">${item.brand}</div>
                        <div class="price">${item.price}</div>
                        <div class="item-delivery"><i class="fa-solid fa-truck"></i>Delivery by Dec 20</div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="decreaseQty('${item.id}')">-</button>
                            <span>${item.quantity}</span>
                            <button class="qty-btn" onclick="increaseQty('${item.id}')">+</button>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn remove" onclick="removeItem('${item.id}')"><i class="fa-solid fa-trash"></i>Remove</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            updateSummary(subtotal);
        }

        async function increaseQty(productId) {
            const item = currentCartItems.find(i => i.id === productId);
            if (item) {
                await updateCartQuantity(productId, item.quantity + 1);
            }
        }

        async function decreaseQty(productId) {
            const item = currentCartItems.find(i => i.id === productId);
            if (item) {
                await updateCartQuantity(productId, item.quantity - 1);
            }
        }

        async function removeItem(productId) {
            if (confirm('Remove this item from cart?')) {
                await removeFromCart(productId);
                showToast('Item removed from cart');
            }
        }

        function updateSummary(subtotal) {
            const shipping = subtotal > 5000 ? 0 : 200;
            const discountAmt = Math.round(subtotal * promoDiscount / 100);
            const total = subtotal + shipping - discountAmt;

            document.getElementById('subtotal').textContent = 'Rs. ' + subtotal.toLocaleString();
            document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : 'Rs. ' + shipping;
            document.getElementById('shipping').style.color = shipping === 0 ? '#4CAF50' : '#aaa';
            document.getElementById('discount').textContent = '-Rs. ' + discountAmt.toLocaleString();
            document.getElementById('discount-row').style.display = promoDiscount > 0 ? 'flex' : 'none';
            document.getElementById('total').textContent = 'Rs. ' + total.toLocaleString();
        }

        function applyPromo() {
            const code = document.getElementById('promo-code').value.toUpperCase();
            if (promoCodes[code]) {
                promoDiscount = promoCodes[code];
                document.getElementById('promo-applied').style.display = 'flex';
                document.getElementById('promo-msg').textContent = `${code} applied! ${promoDiscount}% off`;
                renderCart(currentCartItems);
            } else {
                alert('Invalid promo code');
            }
        }

        function showToast(message) {
            const existingToast = document.querySelector('.cart-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'cart-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #8E7C68, #C5A065);
                color: white;
                padding: 15px 30px;
                border-radius: 50px;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease, fadeOut 0.3s ease 2.5s forwards;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Recommendations
        const recs = [
            { name: 'Nike Air Max', price: 'Rs. 12,000', img: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=200' },
            { name: 'Galaxy Buds', price: 'Rs. 21,000', img: 'https://images.unsplash.com/photo-1590658268037-6bf12165a8df?w=200' },
            { name: 'Summer Kurta', price: 'Rs. 4,500', img: 'https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=200' },
            { name: 'Luxury Watch', price: 'Rs. 150,000', img: 'https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=200' }
        ];
        document.getElementById('recommendations').innerHTML = recs.map(p => `
            <div class="rec-card" onclick="location.href='product.html?name=${encodeURIComponent(p.name)}'">
                <img src="${p.img}"><h4>${p.name}</h4><div class="price">${p.price}</div>
            </div>
        `).join('');
    </script>

    <!-- Stripe Checkout Integration -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Initialize Stripe (replace with your publishable key after deployment)
        const stripe = Stripe('pk_test_51QXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXmY');

        async function proceedToStripeCheckout() {
            const user = firebase.auth().currentUser;

            // Check if user is logged in
            if (!user) {
                window.location.href = 'login.html?return=cart.html';
                return;
            }

            // Check if cart has items
            if (currentCartItems.length === 0) {
                showToast('Your cart is empty');
                return;
            }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading Checkout...';

            try {
                // Create checkout session
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: currentCartItems,
                        userId: user.uid,
                        userEmail: user.email
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create checkout session');
                }

                const { sessionId } = await response.json();

                // Redirect to Stripe Checkout
                const { error } = await stripe.redirectToCheckout({ sessionId });

                if (error) {
                    console.error('Stripe redirect error:', error);
                    showToast(error.message);
                }

            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to start checkout. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Checkout';
            }
        }
    </script>
</body>

</html>